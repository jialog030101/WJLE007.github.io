---
title: "CMU15-445-Project #2 - B+ Tree Index Checkpoint 1"
tags:
  - Project
  - CMU15-445
date: 2024-02-01
categories:
  - CMU15-445
---
## ä¸€äº›å·¥å…·
- [BusTub B+Tree Printer](https://15445.courses.cs.cmu.edu/fall2022/bpt-printer/)CMUå®˜æ–¹åœ¨çº¿çš„B+æ ‘çš„ç”Ÿæˆå·¥å…·ã€‚æˆ‘ä¸»è¦ç”¨æ¥ç»†èŠ‚å®ç°çš„æ—¶å€™è¿›è¡Œå‚è€ƒã€‚
- [JavaScript B+ Tree](https://goneill.co.nz/btree-demo.php)B+æ ‘æ’å…¥å’Œåˆ é™¤çš„åŠ¨æ€æ¼”ç¤ºã€‚
- [Graphviz Online](https://dreampuf.github.io/GraphvizOnline/#digraph%20G%20%7B%0A%0A%20%20subgraph%20cluster_0%20%7B%0A%20%20%20%20style%3Dfilled%3B%0A%20%20%20%20color%3Dlightgrey%3B%0A%20%20%20%20node%20%5Bstyle%3Dfilled%2Ccolor%3Dwhite%5D%3B%0A%20%20%20%20a0%20-%3E%20a1%20-%3E%20a2%20-%3E%20a3%3B%0A%20%20%20%20label%20%3D%20%22process%20%231%22%3B%0A%20%20%7D%0A%0A%20%20subgraph%20cluster_1%20%7B%0A%20%20%20%20node%20%5Bstyle%3Dfilled%5D%3B%0A%20%20%20%20b0%20-%3E%20b1%20-%3E%20b2%20-%3E%20b3%3B%0A%20%20%20%20label%20%3D%20%22process%20%232%22%3B%0A%20%20%20%20color%3Dblue%0A%20%20%7D%0A%20%20start%20-%3E%20a0%3B%0A%20%20start%20-%3E%20b0%3B%0A%20%20a1%20-%3E%20b3%3B%0A%20%20b2%20-%3E%20a3%3B%0A%20%20a3%20-%3E%20a0%3B%0A%20%20a3%20-%3E%20end%3B%0A%20%20b3%20-%3E%20end%3B%0A%0A%20%20start%20%5Bshape%3DMdiamond%5D%3B%0A%20%20end%20%5Bshape%3DMsquare%5D%3B%0A%7D)å¯è§†åŒ–è‡ªå·±çš„æ ‘ã€‚åœ¨debugçš„æ—¶å€™ä¼šç”¨åˆ°ã€‚å°†ç”Ÿæˆçš„dotæ–‡ä»¶è½¬æ¢æˆsvgå›¾ç‰‡ã€‚
- [Log In | Gradescope](https://www.gradescope.com/courses/425272)åœ¨çº¿è¯„æµ‹ç½‘ç«™,é‚€è¯·ç ï¼šPXWVR5ï¼Œ
- [Project #2 - B+Tree | CMU 15-445/645 :: Intro to Database Systems (Fall 2022)](https://15445.courses.cs.cmu.edu/fall2022/project2/)æœ€é‡è¦çš„å½“ç„¶è¿˜æ˜¯è¯¾ç¨‹ç½‘ç«™äº†
- è¯¾ç¨‹çš„è§†é¢‘ï¼Œè¿˜æœ‰å¯¹åº”çš„æ•™æè¿˜æ˜¯æ¨èçœ‹ä¸€ä¸‹çš„ä¸Šé¢æœ‰å¾ˆå¤šå®ç°ç»†èŠ‚çš„ã€‚éå¸¸å€¼å¾—å‚è€ƒã€‚

### å¦‚ä½•Debugè‡ªå·±çš„ğŸŒ³

å¤§è‡´ä¸Šå¯ä»¥åˆ†ä¸ºä¸¤ç§æ–¹å¼
- å¯è§†åŒ–çš„ç”¨è‡ªå¸¦çš„`printer`å°†æ ‘ç”Ÿæˆdotæ–‡ä»¶ç„¶åå¤åˆ¶åˆ°ä¸Šé¢çš„å¯è§†åŒ–ç½‘ç«™ã€‚
- ç”±äºæœ¬é¡¹ç›®é‡‡ç”¨çš„æ˜¯cmakeæ„å»ºçš„ï¼Œæ‰€ä»¥å¯ä»¥å¾ˆæ–¹ä¾¿çš„åœ¨æµ‹è¯•æ–‡ä»¶ä¸­æ‰“ä¸Šæ–­ç‚¹ã€‚è¿›è¡Œè°ƒè¯•ã€‚

==å¯è§†åŒ–è°ƒè¯•==

åœ¨ç»ˆç«¯ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ„å»ºå’Œæ‰§è¡Œ`printer`ã€‚
```c++
âœ  build git:(main) make b_plus_tree_printer -j2 // æ„å»ºprinter
âœ  build git:(main) ./bin/b_plus_tree_printer    // æ‰§è¡Œprinter  
```

æ‰§è¡Œå®Œä¹‹åå°±ä¼šæœ‰ä»¥ä¸‹æç¤ºï¼š

![image.png|675](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202215423.png)

æŒ‰ç…§è¿™ä¸ªæç¤ºå°±å¯ä»¥ç”Ÿæˆdotæ–‡ä»¶ï¼Œç„¶åå¤åˆ¶åˆ°ä¸Šè¿°çš„ç½‘ç«™è¿›è¡Œå¯è§†åŒ–ã€‚ï¼ˆå½“ä½ çœ‹åˆ°è‡ªå·±çš„æ ‘å‘ˆç°å‡ºæ¥çš„æ—¶å€™è¿˜æ˜¯éå¸¸æœ‰æˆå°±æ„Ÿçš„ğŸ˜ï¼‰

==éå¯è§†åŒ–==

![image.png|675](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202220003.png)

å¯ä»¥å¾ˆæ–¹ä¾¿çš„ç›´æ¥æ‰“æ–­ç‚¹ï¼Œç„¶ååœ¨vscodeä¸­çš„cmakeæ’ä»¶ä¸­é€‰æ‹©è°ƒè¯•è¿›è¡Œdebugã€‚

å®˜æ–¹è¿˜æä¾›äº†ä¸€ç§å¤§æ‰“logçš„æ–¹å¼è¿›è¡Œdebugï¼Œæˆ‘æ˜¯ä¸å¤ªä¹ æƒ¯è¿™ç§æ–¹å¼æ‰€ä»¥æ²¡æœ‰è¿›è¡Œå¾ˆæ·±å…¥çš„ç ”ç©¶ã€‚æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªå·±è¿›è¡Œäº†è§£ğŸ˜—ã€‚

ä¸¤ç§debugçš„æ–¹å¼æ˜¯**ç›¸è¾…ç›¸æˆçš„**ï¼Œåœ¨ä½ è¿‡ä¸äº†**æœ¬åœ°æ ·ä¾‹**çš„æ—¶å€™å¥½å¥½çš„ç”¨éå¯è§†åŒ–çš„æ–¹å¼è¿›è¡Œdebugï¼Œçº¿ä¸Šæ ·ä¾‹è¿‡ä¸äº†å¤§éƒ¨åˆ†åŸå› æ˜¯ç»†èŠ‚å¤„ç†ä¸Šå‡ºé—®é¢˜äº†ã€‚ç”¨å¯è§†åŒ–çš„æ–¹å¼ä¼šæ›´åŠ çš„ç›´è§‚ã€‚

*è¯·ä¸è¦å…¬å¼€ä»£ç ï¼Œå°Šé‡AndyåŠ³åŠ¨æˆæœ*


-----
## æ¦‚è§ˆ
Project2æ˜¯å®ç°B+æ ‘ç´¢å¼•ï¼Œæ•´ä¸ªprojectå¤§è‡´è¢«åˆ†ä¸ºäº†ä¸¤ä¸ªéƒ¨åˆ†
- checkpoint1ï¼šå®ç°ä¸€ä¸ªå•çº¿ç¨‹çš„b+æ ‘ã€‚
- checkpoint2ï¼šå®ç°ä¸€ä¸ªå¤šçº¿ç¨‹çš„b+æ ‘ã€‚

å®éªŒä»£ç ä¸­ç»™å‡ºçš„è‡ªç”±å‘æŒ¥çš„ç©ºé—´éå¸¸çš„å¤§ï¼Œåªç»™å‡ºäº†`Getvalue()`,`Insert()`,`Remove()`è¿™ä¸‰ä¸ªå‡½æ•°çš„æ¥å£ï¼Œå‰©ä¸‹çš„æ‰€æœ‰çš„å®ç°éƒ½éå¸¸çš„è‡ªç”±ï¼Œæ•´ä¸ªå®éªŒå®ç°çš„è¿‡ç¨‹å°±åƒä¸€ä¸ªé»‘ç›’ä¸€æ ·ï¼Œåªåœ¨ä¹è¾“å…¥å’Œè¾“å‡ºã€‚

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202220853.png)

æœ¬å®éªŒéœ€è¦å®Œæˆb+ indexéƒ¨åˆ†ï¼Œb+æ ‘ä¸­çš„é¡µï¼ˆpageï¼‰éƒ½éœ€è¦ä»ä¸Šä¸€ä¸ªå®éªŒä¸­å®ç°çš„buffer poolä¸­å–ã€‚

---

## Checkpoint-1

###  Task #1 - B+Tree Pages

éœ€è¦å®Œæˆä»¥ä¸‹ä¸‰ä¸ªpageï¼Œä¸»è¦éƒ½æ˜¯ä¸€äº›getterå’Œsetterçš„å‡½æ•°ï¼Œé‡åœ¨ç†è§£å„éƒ¨åˆ†çš„ç»„æˆã€‚
- - [**B+Tree Parent Page**](https://15445.courses.cs.cmu.edu/fall2022/project2/#b+tree-page)
- - [**B+Tree Internal Page**](https://15445.courses.cs.cmu.edu/fall2022/project2/#b+tree-internal-page)
- - [**B+Tree Leaf Page**](https://15445.courses.cs.cmu.edu/fall2022/project2/#b+tree-leaf-page)

å…¶ä¸­parentPageæ˜¯internal pageå’Œleaf pageçš„çˆ¶ç±»ã€‚æˆ‘æ›´**å€¾å‘äº**æŠŠè¿™å‡ ä¸ªpageç±»å‹ç†è§£ä¸º ä»buffer poolä¸­å–å›æ¥çš„Pageçš„**ä¸åŒè§£é‡Šå½¢å¼**ã€‚Pageè¿˜æ˜¯é‚£ä¸ªPageã€‚ä¸»è¦å°±æ˜¯åœ¨äºä½ å¦‚ä½•å»è§£é‡Šå®ƒçš„ç»„æˆéƒ¨åˆ†ã€‚

==Pageçš„ç»„æˆ==

é¦–å…ˆå›é¡¾ä¸€ä¸‹åœ¨P1ä¸­å°±å·²ç»æ¥è§¦åˆ°çš„Pageã€‚è¿™ä¸ªPageæˆ‘ç†è§£ä¸ºæ•°æ®åœ¨diskä¸Šçš„å­˜å‚¨å•ä½ã€‚ç›¸å½“äºä¸€ä¸ªè®¡é‡æ¦‚å¿µã€‚

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202230539.png)

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202231733.png)

å¯ä»¥çœ‹å‡ºè¿™ä¸ªdata_æ•°ç»„çš„å¤§å°ä¸º4096Bå³4KBã€‚è¿™ä¸ªå¤§å°æ˜¯å®šä¹‰çš„å¸¸é‡`BUSTUB_PAGE_SIZE`å†³å®šçš„ã€‚

æœ¬é¡¹ç›®çš„æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯åœ¨data_ä¸­çš„ã€‚-----æˆ‘ç†è§£çš„å°±æ˜¯å¯¹dataæ•°ç»„ä¸­çš„æ•°æ®è§£é‡Šæ–¹å¼ä¸åŒã€‚

==BPlusTreePage==

è¿™æ˜¯internal pageå’Œleaf pageçš„çˆ¶ç±»`b_plus_tree_page`ã€‚

```cpp
IndexPageType page_type_;   // leaf or internal. 4 Byte
lsn_t lsn_  // temporarily unused. 4 Byte
int size_;  // tree page data size(not in byte, in count). 4 Byte
int max_size_;  // tree page data max size(not in byte, in count). 4 Byte
page_id_t parent_page_id_; // 4 Byte
page_id_t page_id_; // 4 Byte
// 24 Byte in total
```

ä»¥ä¸Šéƒ¨åˆ†ç»„æˆäº†ä¸¤ç§èŠ‚ç‚¹çš„å…¬å…±éƒ¨åˆ†ï¼Œå…±å æ®24Bï¼Œè¿˜å‰©ä¸‹4KB-24Bçš„ç©ºé—´ï¼Œä½†æ˜¯å¦‚ä½•ä½¿ç”¨è¿™å‰©ä¸‹çš„ç©ºé—´å‘¢ï¼Ÿ
å¯ä»¥ä»ä¸‹é¢çš„è¿™ä¸ªflexibleæ•°ç»„æ‰¾åˆ°ç­”æ¡ˆã€‚è¿™ä¸ªå¤§ä½¬è§£é‡Šçš„æ¯”è¾ƒçš„è¯¦ç»†ï¼Œæˆ‘ä¹Ÿæ˜¯åœ¨è¿™çœ‹åˆ°çš„ã€‚[åšä¸ªæ•°æ®åº“ï¼š2022 CMU15-445 Project2 B+Tree Index - çŸ¥ä¹](https://zhuanlan.zhihu.com/p/580014163)

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202234104.png)
ä¼—æ‰€å‘¨çŸ¥ï¼Œæ•°æ®åœ¨æ•°ç»„ä¸­çš„æ’åˆ—æ˜¯è¿ç»­çš„ï¼Œå¯ä»¥é€šè¿‡ä¸‹æ ‡ä¸€ç›´å‘ä¸‹è¿›è¡Œè®¿é—®ï¼Œå°±æ˜¯é€šè¿‡åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ä½¿ç”¨å¤´æŒ‡é’ˆåŠ ä¸Šåç§»é‡å°±åˆ°å‡†ç¡®çš„æ‰¾åˆ°æˆ‘ä»¬æƒ³è¦çš„é‚£ä¸ªæ•°æ®ã€‚

å› æ­¤æˆ‘è®¤ä¸ºè¿™ä¸ªarray_æ•°ç»„ç›¸å½“äºæä¾›äº†ä¸€ä¸ªä½¿ç”¨å‰©ä¸‹ç©ºé—´çš„ä¸€ä¸ªå…¥å£ï¼Œæœ‰ä¸ªè¿™ä¸ª**é—¨æŠŠæ‰‹**å°±å¯ä»¥è½»æ¾çš„ä½¿ç”¨å‰©ä¸‹çš„ç©ºé—´ã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202234934.png)

å¤§è‡´å¯ä»¥è®¤ä¸ºæ•°æ®å°±æ˜¯ä»¥ä¸Šçš„è¿™ç§å½¢å¼ã€‚æ¯ä¸€ä¸ªå°æ–¹æ ¼éƒ½æ˜¯ä¸€ä¸ªkvå¯¹ã€‚

---
ä»Šå¤©æˆ‘åœ¨ç½‘ä¸Šå†²æµªçš„æ—¶å€™å‘ç°äº†æ›´åŠ è¯¦ç»†çš„å…³äºæŸ”æ€§æ•°ç»„çš„ä¿¡æ¯ã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240221132115.png)
æˆªå›¾è‡ª[Cè¯­è¨€ç»“æ„ä½“é‡Œçš„æˆå‘˜æ•°ç»„å’ŒæŒ‡é’ˆ | é…· å£³ - CoolShell](https://coolshell.cn/articles/11377.html)ã€‚
åŒæ—¶è¿™ç¯‡æ–‡ç« ä¹Ÿè´´å‡ºäº†æ–‡ç« å‡ºå¤„[Zero Length (Using the GNU Compiler Collection (GCC))](https://gcc.gnu.org/onlinedocs/gcc/Zero-Length.html)ã€‚

ç°åœ¨ç»†ç»†æƒ³æ¥è¿™ç¯‡åšå®¢æˆ‘å¾ˆæ—©å…¶å®å°±çœ‹åˆ°è¿‡ï¼Œä½†æ˜¯åœ¨å½“æ—¶æˆ‘æ€»è§‰å¾—è¿™äº›éƒ½æ˜¯ä¸€äº›è¯­æ³•ç³–ç½¢äº†ï¼Œæ²¡æƒ³åˆ°è‡ªå·±é”™å¤±äº†å¾ˆå¤šå­¦ä¹ çš„æœºä¼šã€‚ğŸ¤¤


==Internalpage==

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202235613.png)

ä¸Šå›¾ä¸­çº¢è‰²çš„å°±æ˜¯internalpageã€‚
æˆ‘ä»¬å‘ç°ç¬¬ä¸€ä¸ªkeyæ˜¯ç©ºç€çš„ï¼Œä½†æ˜¯valueæŒ‡å‘äº†å°äºvalueï¼ˆ1ï¼‰çš„pageã€‚å…¶å®internalçš„valueå­˜æ”¾çš„æ˜¯pageidã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240202235848.png)
æ‰€ä»¥internalpageçš„ç¬¬ä¸€ä¸ªkeyè¦ç½®ç©ºå¤„ç†ï¼Œå…¶å®æœ€åä¸€ä¸ªç½®ç©ºä¹Ÿå¯ä»¥äº†ï¼Œåªè¦èƒ½è‡ªæ´½å°±å¯ä»¥äº†ã€‚

	éœ€è¦æ³¨æ„çš„æ˜¯ï¼šè¿™é‡Œåªå­˜æ”¾å­©å­èŠ‚ç‚¹çš„pageIdï¼Œæ‰¾åˆ°è¿™ä¸ªidä¹‹åå–buffer poolé‡Œå–


==LeafPage==

åŸºæœ¬ç»„æˆå’Œè¿™ä¸ªinternalpageæ˜¯ä¸€æ ·çš„ï¼Œå¤šäº†ä¸€ä¸ª`next_page_id`.
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203000849.png)
è¿™ä¸ª`next_page_id`ç”¨ä¸æŒ‡å‘ç›¸é‚»çš„å¶å­èŠ‚ç‚¹ï¼Œä»ä¸Šå›¾ä¸­ç»¿è‰²å¶å­èŠ‚ç‚¹çš„æŒ‡é’ˆå°±èƒ½çœ‹å‡ºæ¥ã€‚
è¿™ä¸ªçš„ä¸»è¦ä½œç”¨å°±æ˜¯èƒ½å¤Ÿè¿›è¡Œ**éå†**ã€‚

**éœ€è¦è¯´æ˜çš„ä¸€ç‚¹æ˜¯**ï¼šåœ¨å¶å­èŠ‚ç‚¹ä¸­keyæ˜¯ç´¢å¼•ï¼Œvalueæ˜¯recordIdï¼Œè¿™ç§å½¢å¼ä¹Ÿå°±æ˜¯*äºŒçº§ç´¢å¼•*
åœ¨æ•°æ®åº“ä¸­éœ€è¦æ‹¿åˆ°è¿™ä¸ªrecodeIdä¹‹åè¿”å›è¡¨ä¸­è¿›è¡ŒæŸ¥è¯¢ã€‚å¤§å¤§åŠ å¿«æŸ¥è¯¢çš„é€Ÿåº¦ã€‚

æˆ‘è§‰å¾—äºŒçº§ç´¢å¼•æœ‰ä»¥ä¸‹å‡ ä¸ª**ä¼˜åŠ¿**ï¼š
- æ›´æ–°çš„ä»£ä»·å¾ˆä½ï¼šå› ä¸ºvalueéƒ½åªæ˜¯ä¸€äº›idæ‰€ä»¥å å¾—ç©ºé—´å¾ˆå°ï¼Œå¤„ç†èµ·æ¥å¼€é”€è‡ªç„¶å°±å°äº†ã€‚
- ä¸€å¼ è¡¨èƒ½å¤Ÿç»„ç»‡å¤šä¸ªç´¢å¼•ï¼šæ›´æ¢ä¸åŒçš„keyå°±èƒ½ç»„ç»‡èµ·æ¥ä¸€ä¸ªç´¢å¼•ã€‚

Task1çš„å†…å®¹å¾ˆç®€å•ï¼ŒåŸºæœ¬å°±ä¸Šè¿°è¿™äº›ï¼Œä¸»è¦æ˜¯å¼„æ¸…æ¥špageçš„ç»„æˆï¼Œå’Œæ¡†æ¶çš„æ„å»ºã€‚è¢«æŠ˜ç£¨äº†è¿™ä¹ˆå¤šå¤©çš„æˆ‘çœŸå¿ƒå»ºè®®å¤šç”¨æä¾›çš„å·¥å…·ç”»ä¸€äº›æ ‘å…ˆä¸è¦ç€æ€¥åŠ¨æ‰‹ï¼Œæƒ³æ¸…æ¥šæ¯ä¸ªéƒ¨åˆ†çš„ç»„æˆå’Œä½œç”¨å†ä¸‹æ‰‹ä¹Ÿä¸è¿Ÿï¼Œæ­£æ‰€è°“ç£¨åˆ€ä¸è¯¯ç æŸ´å·¥ã€‚

==è¡¥å……ä¸€ç‚¹==

**èšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ï¼ˆäºŒçº§ç´¢å¼•ï¼‰**
ä¸€è¨€ä»¥è”½åŠï¼šèšç°‡ç´¢å¼•çš„valueå°±æ˜¯ä½ æƒ³è¦æ‰¾çš„æ•°æ®æˆ–è€…æ˜¯æ•°æ®æ‰€åœ¨çš„é¡µæœ¬èº«ï¼Œéèšç°‡ç´¢å¼•å­˜æ”¾çš„ç›¸å½“äºæ˜¯ä½ æƒ³è¦çš„æ•°æ®æ‰€åœ¨ä½ç½®çš„å¿«é€ŸæŒ‡é’ˆå¸®åŠ©ä½ å¿«é€Ÿå®šä½ã€‚

---

### Task #2 - B+Tree Data Structure

task2æ˜¯checkpoint1çš„é‡å¤´æˆï¼Œéå¸¸çš„æœ‰æ„æ€ã€‚
æœ‰å‡ ä¸ªéœ€è¦æ³¨æ„çš„ç‚¹ï¼š
- è¦æ±‚æ­¤b+æ ‘çš„ç´¢å¼•æ˜¯å”¯ä¸€çš„ï¼Œä¸æ”¯æŒé‡å¤çš„æ’å…¥ã€‚
- `UpdateRootPageId`åœ¨root_page_idå‘ç”Ÿæ”¹å˜çš„æ—¶å€™éœ€è¦è°ƒç”¨å·²ç»å®ç°å¥½çš„è¿™ä¸ªå‡½æ•°ï¼Œä¿è¯æ ‘çš„æŒä¹…åŒ–ã€‚
- åœ¨å®ç°çš„æ—¶å€™ä¸€å®šå¤šå¤šè€ƒè™‘å®ç°çš„ç»†èŠ‚ï¼Œæ¯”å¦‚æ¯ç§èŠ‚ç‚¹çš„æœ€å¤§æœ€å°å€¼ï¼Œ`æ’å…¥åçš„é”®/å€¼å¯¹çš„æ•°é‡ç­‰äºå¶èŠ‚ç‚¹çš„max_sizeï¼Œæ’å…¥å‰çš„å­èŠ‚ç‚¹çš„æ•°é‡ç­‰äºå†…éƒ¨èŠ‚ç‚¹çš„max_sizeã€‚`

ä¸‹é¢æŒ‰ç…§å‡½æ•°çš„é¡ºåºè¿›è¡Œä»‹ç»ã€‚
åœ¨ä»‹ç»å‡½æ•°ä¹‹å‰æˆ‘æƒ³è¯´æ˜ä¸€ä¸‹`Transaction`è¿™ä¸ªç±»çš„ä½œç”¨ã€‚é¡¾åæ€ä¹‰ï¼Œè¿™ä¸ªTransactionè¢«ç¿»è¯‘ä¸ºäº‹åŠ¡ã€‚åœ¨è¿™ç¯‡æ–‡ç« ä¸­å¯¹è¿™ä¸ªäº‹åŠ¡æœ‰ç€è¯¦ç»†çš„ä»‹ç»ã€‚[[æŸ¥è¯¢çš„å¤„ç†å’Œä¼˜åŒ–]]ã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203152518.png)
åœ¨è¿™ä¸ªç±»ä¸­å®ç°äº†å¾ˆå¤šå‡½æ•°ï¼Œå¯ä»¥æŠŠéœ€è¦å¤„ç†çš„pageæ”¾åœ¨å®åŠ¡ä¸­ç­‰ç»“æŸäº†è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚å› ä¸ºåœ¨å‡½æ•°ä¸­æ¶‰åŠåˆ°å¾ˆå¤šçš„fetchå’Œunpinï¼Œè€Œä¸”å‡½æ•°è¿˜æœ‰é€’å½’åµŒå¥—ï¼Œå¤„ç†èµ·æ¥æ˜¯éå¸¸çš„éº»çƒ¦ï¼Œæ‰€ä»¥æˆ‘å»ºè®®ç›´æ¥å°è¯•ä½¿ç”¨transactionï¼Œåæ­£åé¢ä¹Ÿè¦ç”¨ã€‚ ^d53eec

#### GetValueï¼ˆï¼‰

==GetValueï¼ˆï¼‰==

å†™åˆ°è¿™é‡Œçš„æ—¶å€™ç†åº”å¯¹b+æ ‘çš„ç»“æ„éå¸¸çš„äº†è§£ï¼Œå…¶å®ä¹Ÿå°±æ˜¯ä¸¤ç§èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯internalï¼Œä¸€ç§æ˜¯leafï¼Œä»rootèŠ‚ç‚¹å¼€å§‹å¯»æ‰¾æ¯ä¸€ä¸ªèŠ‚ç‚¹ä¸­**æœ€åä¸€ä¸ª**<=è¾“å…¥keyçš„å€¼ã€‚ç„¶åæ‰¾åˆ°keyæ‰€åœ¨çš„leafèŠ‚ç‚¹ï¼Œä»å‰å‘åéå†ï¼Œæ‰¾åˆ°æƒ³è¦çš„å€¼ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç¤ºæ„å›¾ğŸ‘‡ã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203154935.png)

å…¶å®æ— è®ºæˆ‘ä»¬æ˜¯æŸ¥æ‰¾ï¼Œæ’å…¥ï¼Œè¿˜æ˜¯åˆ é™¤ï¼Œé¦–å…ˆéƒ½å¿…é¡»æ‰¾åˆ°keyæ‰€åœ¨çš„leafèŠ‚ç‚¹ã€‚ç”±æ­¤å¯ä»¥å°†ä¸Šé¢è¿™ä¸ª**å¯»æ‰¾keyæ‰€åœ¨çš„leafèŠ‚ç‚¹**çš„è¿‡ç¨‹å°è£…å‡ºä¸€ä¸ªä½¿ç”¨é¢‘ç‡æé«˜è€Œä¸”éå¸¸é‡è¦çš„å‡½æ•°ï¼š`FindLeafPage()`ã€‚æˆ‘ä»¬ä»ä¹¦ä¸Šç»™å‡ºçš„ä¼ªä»£ç å’Œä¸Šè¿°æ¨¡æ‹Ÿè¿‡ç¨‹å¯¹ç…§åˆ†æã€‚

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203155759.png)

è™½ç„¶è¯´æˆ‘ä»¬è¦æ‰¾çš„æ˜¯æœ€åä¸€ä¸ª<=è¾“å…¥keyçš„å€¼ï¼Œä½†æ˜¯åœ¨å…·ä½“çš„ä¼ªä»£ç å®ç°ä¸­ç¡®å®å¯»æ‰¾ç¬¬ä¸€ä¸ª>=è¾“å…¥keyçš„å€¼ï¼Œå¹¶è¿›è¡Œåˆ†ç±»è®¨è®ºã€‚

```cpp
auto next_page = buffer_pool_manager_->FetchPage(curr_internal->LookUp(key, comparator_));
```

```cpp
auto target=std::lower_bound(array_+1,array_+GetSize(),key,[&keyComparator](auto const&pair,auto k){return keyComparator(pair.first,k)<0; });
Â  Â  if (target==array_+GetSize())
Â  Â  {
Â  Â  Â  return ValueAt(GetSize()-1); // è¾“å…¥çš„keyæ¯”æ‰€æœ‰çš„å€¼éƒ½å¤§ï¼Œè¿”å›æœ€åä¸€ä¸ª
Â  Â  }
Â  Â  if (keyComparator(target->first,key)==0)
Â  Â  {
 return target->second; //æ‰¾åˆ°çš„targetçš„keyå’Œè¾“å…¥çš„keyç›¸åŒå°±è¿”å›targetçš„value
Â  Â  }
Â  Â return std::prev(target)->second; // æ‰¾åˆ°äº†ç¬¬ä¸€ä¸ªå¤§äºkeyçš„targetï¼Œè¿”å›å‰ä¸€ä¸ªçš„valueã€‚
```
LookUpè¿”å›çš„å°±æ˜¯page_id,å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°è¿‡ï¼ŒinternalèŠ‚ç‚¹çš„valueå°±æ˜¯page_id.
è¿™é‡Œç”¨åˆ°äº†lower_boundï¼ˆï¼‰å‡½æ•°ï¼Œæ¯”è‡ªå·±å®ç°äºŒåˆ†æŸ¥æ‰¾ä¼šæ–¹ä¾¿ä¸€äº›ã€‚

ä½†æ˜¯è¿™ä¸ªlower_boundå‡½æ•°ä¼ å…¥äº†`keycompareterï¼ˆï¼‰`çš„æ¯”è¾ƒæ–¹æ³•ï¼Œè¿›è¡Œäº†å›è°ƒå‡½æ•°çš„æ”¹é€ ï¼Œä½¿ç”¨ç±»å®šä¹‰çš„æ¯”è¾ƒè§„åˆ™ã€‚ä¸æ˜¯ç®€å•çš„æ¯”å¤§å°ã€‚

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203162440.png)

ç°åœ¨æ‰¾åˆ°äº†keyæ‰€åœ¨çš„pageæˆ‘ä»¬è¯¥**å¦‚ä½•ä½¿ç”¨**è¿™ä¸ªpageå‘¢ï¼Ÿ
```cpp
auto leaf_page = reinterpret_cast<LeafPage *>(page->GetData());
```

é€šè¿‡`reinterpret_cast`å°†pageè§£é‡Šä¸º`LeafPage`ç±»å‹ã€‚æ¥ä¾›æˆ‘ä»¬è¿›è¡Œä½¿ç”¨ã€‚éœ€è¦æ³¨æ„çš„æ˜¯è¿™ç§æ–¹å¼éå¸¸çš„ä¸å®‰å…¨ï¼Œåªæ˜¯å°†åŒæ ·çš„æ•°æ®è¿›è¡Œäº†ä¸åŒçš„è§£é‡Šã€‚åªæœ‰åœ¨æˆ‘ä»¬éå¸¸æ¸…æ¥šä¸¤è€…ä¹‹é—´çš„å…³ç³»çš„æ—¶å€™ä½¿ç”¨æ‰ä¸å®¹æ˜“å‡ºé”™ã€‚

æ‰¾åˆ°LeafPageååŒæ ·ä½¿ç”¨ä¸Šè¿°æ”¹é€ è¿‡åçš„çš„lower_bound()å‡½æ•°è¿›è¡ŒæŸ¥æ‰¾keyğŸ˜€ã€‚

==è®°å¾—UnpinPage==

åœ¨ä½¿ç”¨å®Œpageä¹‹åä¸€å®šè®°å¾—unpinä¸ç„¶çš„è¯é«˜å¼ºåº¦ä½¿ç”¨è¿‡åå†…å­˜ä¼šä¸è¶³ã€‚
æˆ‘çš„æ¯”è¾ƒå»ºè®®è¿˜æ˜¯ä¹‹å‰æåˆ°çš„`transaction`ï¼Œè¿›è¡Œç»Ÿç­¹å¤„ç†ï¼Œå°‘æ­»ç‚¹è„‘ç»†èƒã€‚
#### Insertï¼ˆï¼‰
ç›¸è¾ƒäºä¸Šä¸€ä¸ªå‡½æ•°è€Œè¨€ï¼Œinsertï¼ˆï¼‰çš„é€»è¾‘å°±ç›¸å¯¹è€Œè¨€è¦å¤æ‚ä¸€äº›äº†ã€‚

==Insertï¼ˆï¼‰==
æ’å…¥ä¸€ä¸ªkvå¯¹ç”±å°‘åˆ°å¤šçš„æƒ…å†µä¸€ä¸ªä¸€ä¸ªè¿›è¡Œæ¢³ç†
- åˆšå¼€å§‹æ ‘æ˜¯ç©ºçš„ï¼šéœ€è¦æ–°å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹ã€‚
- æœ‰ç©ºé—´èƒ½å¤Ÿç›´æ¥æ’å…¥
- æ’å…¥ä¹‹åpageSize=leafMaxSizeï¼Œéœ€è¦è¿›è¡Œåˆ†è£‚ï¼Œåˆ†è£‚ä¹‹åå°†æ–°çš„pageæ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¸­ã€‚
- æœ‰é‡å¤çš„æ’å…¥ï¼Œç›´æ¥è¿”å›ã€‚

ç°åœ¨å†çœ‹ä¼ªä»£ç å¤§æ¦‚çš„æƒ…å†µä¹Ÿæ˜¯è¿™å‡ ç§ã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203221858.png)

å¯¹ç…§ä»£ç å†åˆ†æä¸€ä¸‹ï¼š

```cpp
INDEX_TEMPLATE_ARGUMENTS
auto BPLUSTREE_TYPE::Insert(const KeyType &key, const ValueType &value, Transaction *transaction) -> bool {
Â  if (IsEmpty()) {
Â  Â  StartNewTree(key, value); // è¿™ä¸ªå¯¹åº”ç©ºæ ‘çš„æƒ…å†µï¼Œ
Â  Â  return true;
Â  }
Â  return InsertIntoLeaf(key, value, transaction); // å‰©ä¸‹çš„æ‰€æœ‰æƒ…å†µéƒ½åœ¨è¿™å¤„ç†
}
```

![image.png|400](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240203231409.png)
ä¹¦ä¸Šç»™çš„ä¼ªä»£ç æ˜¯æ’å…¥ä¹‹å‰ä¸`(leaf_max_size-1)`è¿›è¡Œæ¯”è¾ƒï¼Œæˆ‘åœ¨å¤„ç†çš„æ—¶å€™æ˜¯æ’å…¥ä¹‹åä¸`leaf_max_size`è¿›è¡Œæ¯”è¾ƒã€‚

âš ï¸ è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯LeafPageå’ŒInternalPageçš„åˆ†è£‚æ¡ä»¶å¹¶ä¸ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´leafpageä¸­æœ€å¤šæœ‰`(leaf_max_size-1)`ä¸ªkvå¯¹ï¼Œè€Œinternalä¸­å¯ä»¥æœ‰`internal_max_size`ä¸ªkvå¯¹ã€‚
![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240204004644.png)
ä¸¤ä¸ªçš„max_sizeéƒ½æ˜¯5ï¼Œä½†æ˜¯æœ€å¤šçš„kvå¯¹ç¡®æ˜¯ä¸ä¸€æ ·çš„ã€‚

==InsertIntoLeaf()==

```cpp
  auto leaf_page = reinterpret_cast<LeafPage *>(page->GetData());
Â  int pre_size = leaf_page->GetSize();
Â  int curr_size = leaf_page->Insert(key, valueType, comparator_);
Â  if (pre_size == curr_size) {
Â  Â  // è¿™æ˜¯æœ‰é‡å¤çš„èŠ‚ç‚¹ç›´æ¥è¿”å›
Â  Â  Unpin(transaction, I);
Â  Â  return false;
Â  }
Â  if (curr_size == leaf_max_size_) { Â // æ’å…¥ä¹‹åç­‰äºå¶å­èŠ‚ç‚¹çš„æœ€å¤§å€¼é‚£ä¹ˆå°±è¿›è¡Œæ„‰å¿«çš„åˆ†è£‚å§ã€‚
Â page_id_t new_page_leaf_id;
auto new_leaf_node_page = buffer_pool_manager_-NewPage(&new_page_leaf_id);
auto new_leaf = reinterpret_cast<LeafPage *>(new_leaf_node_page->GetData());
new_leaf->Init(new_page_leaf_id, INVALID_PAGE_ID, leaf_max_size_);
Â  Â  leaf_page->Split(new_leaf_node_page);
Â  Â  InsertIntoParent(page, new_leaf->KeyAt(0), new_leaf_node_page, transaction);
Â  }
```

åˆ°è¿™é‡Œæ‰€æœ‰çš„æ’å…¥çš„æƒ…å†µå°±å·²ç»è€ƒè™‘å®Œå…¨äº†ï¼Œä½†æ˜¯åˆ†è£‚ä¹‹åéœ€è¦å°†æ–°åˆ†è£‚çš„é¡µæ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¸­ï¼Œæ’å…¥åˆ°çˆ¶èŠ‚ç‚¹ä¸­ä¹‹ååˆæ¶‰åŠåˆ°çˆ¶èŠ‚ç‚¹åˆ†è£‚çš„é—®é¢˜ï¼Œè¿™å°±æ˜¯ä¸€ä¸ªé€’å½’åµŒå¥—äº†

==InsertIntoParent()==

![image.png|600](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240204005750.png)
ä»”ç»†çœ‹ä¼ªä»£ç çš„å†™æ³•ï¼ŒåŸºæœ¬æ˜¯æŒ‰ç…§ä¼ªä»£ç ä¸€æ­¥æ­¥å†™æˆçš„ã€‚

```cpp
INDEX_TEMPLATE_ARGUMENTS
auto BPLUSTREE_TYPE::InsertIntoParent(Page *old_leaf, const KeyType &key, Page *new_leaf, Transaction *transaction)-> void{
// å¦‚æœåŸé¡µæ˜¯æ ¹èŠ‚ç‚¹ï¼Œé‚£ä¹ˆæ–°å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œå°†æ–°æ—§èŠ‚ç‚¹æ’å…¥åˆ°æ–°çš„æ ¹èŠ‚ç‚¹ä¸­ï¼Œå¹¶æ›´æ–°èŠ‚ç‚¹
ifï¼ˆold_leaf->pageID==root_page_idï¼‰{
 //æ–°å»ºä¸€ä¸ªèŠ‚ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼ŒæŠŠä¸¤ä¸ªéƒ½æ’å…¥ä¹‹åæ›´æ–°å„è‡ªçš„æŒ‡é’ˆ
 ps.è¿›åˆ°è¿™ä¸ªå‡½æ•°çš„æ—¶å€™è¯´æ˜æ ¹èŠ‚ç‚¹å·²ç»æ»¡äº†ï¼Œæ‰€ä»¥ç›´æ¥åˆ›ä¸€ä¸ªæ–°çš„å°±è¡Œäº†ã€‚
}
ifï¼ˆparent_internal->GetSize() < parent_internal->GetMaxSize()ï¼‰{
// çˆ¶èŠ‚ç‚¹çš„ç©ºé—´æ˜¯å¤Ÿçš„ï¼Œç›´æ¥æ’å…¥å°±è¡Œäº†
}
// å‰©ä¸‹çš„è‡ªç„¶å°±æ˜¯ç©ºé—´ä¸å¤Ÿéœ€è¦è¿›è¡Œçˆ¶èŠ‚ç‚¹åˆ†è£‚çš„æƒ…å†µ
.....
parent_internal->Split(key, new_leaf, new_parent_page, comparator_, buffer_pool_manager_);
......
InsertIntoParent(parent_page, new_parent_internal->KeyAt(0), new_parent_page, transaction);
......
}
```

âš ï¸ internalPageåœ¨åˆ†è£‚çš„æ—¶å€™å°½é‡åˆ›å»ºä¸€ä¸ªtmpç©ºé—´è¿›è¡Œæ’å…¥å’Œé‡æ–°çš„åˆ†é…ï¼Œåœ¨æœ¬å®éªŒä¸­ç›´æ¥åœ¨åŸæ¥çš„é¡µä¸Šæ’å…¥å’Œåˆ†é…é¡µæ²¡æœ‰é—®é¢˜ï¼Œå¦‚æœmaxsizeçš„å¤§å°å¾ˆæé™çš„è¯ï¼Œæ’å…¥ä¸€ä¸ªkvå¯¹å¯èƒ½ä¼šå®¹ä¸ä¸‹ï¼Œå‘ç”Ÿé”™è¯¯ã€‚

#### Removeï¼ˆï¼‰

removeï¼ˆï¼‰å‡½æ•°çš„é€»è¾‘ç›¸è¾ƒäºå‰ä¸¤ä¸ªåˆ™æ˜¯å¤æ‚éå¸¸å¤šçš„ï¼Œä½†æ˜¯æŒ‰ç…§ä¼ªä»£ç æŒ‰å›¾ç´¢éª¥ï¼Œä¸€æ­¥ä¸€æ­¥æ¥ï¼Œæ˜¯èƒ½å¤Ÿå®Œç¾å®ç°çš„ã€‚
![image.png|550](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240204012543.png)

```cpp
auto brother_node = reinterpret_cast<BPlusTreePage *>(brother_page->GetData());
Â  Â  if (brother_node->GetSize() + btree_page->GetSize() <=
Â  Â  Â  Â  (btree_page->IsLeafPage() ? leaf_max_size_ - 1 : internal_max_size_)) {
Â  Â  Â  if (is_pre) {
Â  Â  Â  Â  std::swap(leaf_page, brother_page);
Â  Â  Â  }
Â  Â  Â  Coalesce(leaf_page, brother_page, parent_key, transaction);
Â  Â  Â  DeleteEntry(parent_page, parent_key, transaction);
Â  Â  } else {
Â  Â  Â  Redistribute(leaf_page, brother_page, parent_page, parent_key, is_pre, transaction);
Â  Â  }
```

==DeleteEntry()==

å¤§è‡´æ¢³ç†ä¸€ä¸‹æ€è·¯ï¼š
- é¦–å…ˆæ‰¾åˆ°é¡µä¹‹åè‡ªç„¶æ˜¯åˆ é™¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯leafå’Œinternalçš„ç»„æˆç•¥æœ‰å·®å¼‚ï¼Œéœ€è¦åˆ†åˆ«è¿›è¡Œå¤„ç†
- å¦‚æœæ‰€åœ¨é¡µæ˜¯æ ¹èŠ‚ç‚¹è€Œä¸”åªå‰©ä¸‹ä¸€ä¸ªå­èŠ‚ç‚¹éœ€è¦è¿›è¡Œé¢å¤–çš„`Adjustrootï¼ˆï¼‰`å‡½æ•°è¿›è¡Œæ“ä½œã€‚
- åˆ é™¤ä¹‹åå‘ç°kvå¯¹çš„æ•°é‡å°äºè§„å®šçš„`MinSize()`,é‚£ä¹ˆè¿›è¡Œåˆ†ç±»è®¨è®º
	- å’Œå…„å¼ŸèŠ‚ç‚¹åˆèµ·æ¥`Coalesce()`çš„å¤§å°æ²¡æœ‰è¶…è¿‡maxSizeï¼Œä½†æ˜¯`ä¸åŒç±»å‹çš„èŠ‚ç‚¹maxSizeè®¡é‡æ–¹å¼ä¸åŒ`ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå‘ç‚¹,é‚£å°±å°†ä¸¤ä¸ªèŠ‚ç‚¹åˆå¹¶ï¼Œä½†æ˜¯æœ€åè®°å¾—æŠŠè¢«åˆå¹¶çš„keyä»çˆ¶èŠ‚ç‚¹ä¸­åˆ é™¤
	- å’Œå…„å¼ŸèŠ‚ç‚¹åˆèµ·æ¥çš„å¤§å°è¶…è¿‡äº†maxSizeï¼Œé‚£ä¹ˆéœ€è¦`Redistribute()`,ä»å…„å¼ŸèŠ‚ç‚¹ä¸­åè°ƒä¸€ä¸ªè¿‡æ¥ã€‚è¿™é‡Œåˆ†æˆ**å››ç§**æƒ…å†µï¼Œæ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹ï¼Œä»¥åŠå…„å¼ŸèŠ‚ç‚¹åœ¨å‰åœ¨ååˆ†æˆäº†å››ç§æƒ…å†µ

âš ï¸éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œroot page å¹¶ä¸å— min size çš„é™åˆ¶ã€‚ä½†å¦‚æœ root page è¢«åˆ åˆ° size åªå‰© 1ï¼Œå³åªæœ‰ä¸€ä¸ª child page çš„æ—¶å€™ï¼Œåº”å°†æ­¤ child page è®¾ç½®ä¸ºæ–°çš„ root pageã€‚

è¿˜æœ‰ä¸¤ç§ç±»çš„pageè®¡ç®—maxSizeçš„é€»è¾‘ä¸å¤ªä¸€æ ·éœ€è¦æ³¨æ„ä¸€ä¸‹ã€‚

å¦å¤–ï¼Œåœ¨åˆå¹¶æ—¶ï¼Œä¸¤ä¸ª page åˆå¹¶æˆä¸€ä¸ª pageï¼Œå¦ä¸€ä¸ª page åº”è¯¥åˆ é™¤ï¼Œé‡Šæ”¾èµ„æºã€‚åˆ é™¤ page æ—¶ï¼Œä»æ˜¯è°ƒç”¨ buffer pool çš„Â `DeletePage()`Â å‡½æ•°ã€‚

==AdjustRootï¼ˆï¼‰==
æ ¹èŠ‚ç‚¹åªå‰©ä¸€ä¸ªå­èŠ‚ç‚¹çš„æ—¶å€™å°å°çš„è°ƒæ•´ä¸€ä¸‹ã€‚

==Coalesce()==

è¿˜æ˜¯è¦åŒºåˆ†æ˜¯å¦æ˜¯leafPageï¼Œå¤„ç†æ–¹å¼ä¸å¤ªä¸€æ ·

å¦‚æœæ˜¯leafèŠ‚ç‚¹ç®€ç®€å•å•çš„åˆå¹¶åˆ°ä¸€ä¸ªèŠ‚ç‚¹ç„¶åæ›´æ”¹ä¸€ä¸‹å¶å­èŠ‚ç‚¹çš„nextæŒ‡é’ˆå°±å¤Ÿäº†

å¦‚æœæ˜¯InternalèŠ‚ç‚¹çš„è¯éœ€è¦åˆå¹¶å®Œä¹‹åæ›´æ–°ä¸€ä¸‹å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ã€‚

==Redistributeï¼ˆï¼‰==

å‘ç°ä¸èƒ½åˆå¹¶ä¹‹åå°±åªéœ€è¦ä»å…„å¼ŸèŠ‚ç‚¹å¤„åè°ƒä¸€ä¸ªå³å¯
åè°ƒçš„è¿‡ç¨‹æ¯”è¾ƒç®€å•ï¼Œä»å·¦ä¾§èŠ‚ç‚¹å·å–æ—¶ï¼ŒæŠŠå·¦ä¾§èŠ‚ç‚¹æœ€åä¸€ä¸ª KV å¯¹è½¬ç§»è‡³å½“å‰èŠ‚ç‚¹ç¬¬ä¸€ä¸ª KV å¯¹ï¼Œä»å³ä¾§èŠ‚ç‚¹å·å–æ—¶ï¼ŒæŠŠå³ä¾§èŠ‚ç‚¹çš„ KV å¯¹è½¬ç§»è‡³å½“å‰èŠ‚ç‚¹æœ€åä¸€ä¸ª KV å¯¹ã€‚leaf page å’Œ internal page çš„å·å–è¿‡ç¨‹åŸºæœ¬ç›¸åŒï¼Œä»…éœ€æ³¨æ„ internal page å·å–åæ›´æ–°å­èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æŒ‡é’ˆã€‚

## Summary

ckeckpoint1ä¸»è¦çš„éš¾ç‚¹å°±æ˜¯åœ¨ç»†ææœ«èŠ‚çš„å¤„ç†ä¸Šï¼Œéå¸¸çš„æŠ˜ç£¨äººï¼Œæˆ‘å¼€å§‹æ²¡å¹¶æ²¡æœ‰æŒ‰ç…§ä¸¥æ ¼æŒ‰ç…§ä¼ªä»£ç å†™ï¼Œé™¤äº†å¾ˆå¤šçš„å¥‡å¥‡æ€ªæ€ªçš„bugï¼Œæœ€åå‡ ä¹æ˜¯æ¨åˆ°é‡æ¥ï¼ŒæŒ‰ç…§ä¼ªä»£ç æ‰ç®—æ˜¯èƒ½æ­£ç¡®çš„è¿è¡Œã€‚

ä½†æ˜¯unpinæˆ‘ä¸€ç›´å¤„ç†ä¸å¥½ï¼Œå¡äº†æˆ‘å¥½é•¿æ—¶é—´ï¼Œæœ€åè¿˜æ˜¯ç¥­å‡ºtransactionï¼Œå¥½å¥½ç ”ç©¶äº†ä¸€ä¸‹æ‰æŠŠçº¿ä¸Šè¯„æµ‹è¿‡äº†ã€‚

æœ€åé™„ä¸Šé€šè¿‡æˆªå›¾
![image.png|350](https://weijiale.oss-cn-shanghai.aliyuncs.com/picgo/20240204021017.png)
ä¹Ÿæ˜¯æœ€è¿™ä¸€æ®µæ—¶é—´çš„ä¸€ä¸ªæ€»ç»“ã€‚
